module.exports=function(e){"use strict";var r=require("q"),t=require("crc");if("undefined"==typeof e)var e={};var n=function(e){return t.crc81wire(e)};const i=10;var u=!1;const o=1274,c=9360,s={vendorId:o,productId:c},a={permissions:[{usbDevices:[s]}]};e.checkPermission=function(){var e=r.defer();return chrome.permissions.contains(a,function(r){r?e.resolve():e.reject()}),e.promise},e.requestPermission=function(){var e=r.defer();return chrome.permissions.request(a,function(r){r?e.resolve():e.reject()}),e.promise};var d,f,l;e.openDevice=function(){var e=r.defer();return chrome.usb.getDevices(s,function(r){chrome.usb.findDevices(s,function(t){t&&t.length>0?(f=t[0],d=r[0],chrome.usb.listInterfaces(f,function(r){l=r[0],h(),m().then(e.resolve)})):e.reject()})}),e.promise};var m=function(){var e=r.defer();return chrome.usb.claimInterface(f,l.interfaceNumber,e.resolve),e.promise},v={interrupt:{},bulkIn:{},bulkOut:{}},h=function(){l.endpoints.forEach(function(e){"in"===e.direction&&"interrupt"===e.type?v.interrupt=e:"in"===e.direction&&"bulk"===e.type?v.bulkIn=e:"out"===e.direction&&"bulk"===e.type&&(v.bulkOut=e)})},y=function(){this.handlers=[]};y.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},e.onDeviceRemoved=new y,chrome.usb.onDeviceRemoved.addListener(function(r){r&&r.device===d.device&&e.onDeviceRemoved.dispatch()}),e.interruptTransfer=function(){var e=r.defer(),t={direction:v.interrupt.direction,endpoint:v.interrupt.address,length:32,timeout:i};return chrome.usb.interruptTransfer(f,t,function(r){r.resultCode?e.reject(chrome.runtime.lastError):e.resolve(p(r.data))}),e.promise},e.controlTransfer=function(e){var t=r.defer();return e.timeout=i,chrome.usb.controlTransfer(f,e,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},e.bulkTransfer=function(e){var t=r.defer();return e.timeout=i,chrome.usb.bulkTransfer(f,e,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},e.deviceReset=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:0,value:0,index:0,data:new Uint8Array(0).buffer};return e.controlTransfer(r).then(e.wireDetectShort).then(function(e){if(e)throw new Error("Reset Failed: Short Detected")})};var p=function(e){var r=new Uint8Array(e),t={};return t.SPUE=1&r[0],t.SPCE=r[0]>>3&1,t.Speed=r[1],t.PullupDuration=r[2],t.PulldownSlewRate=r[4],t.WriteLowTime=r[5],t.DataSampleOffset=r[6],t.SPUA=1&r[8],t.PMOD=r[8]>>3&1,t.HALT=r[8]>>4&1,t.IDLE=r[8]>>5&1,t.EP0F=r[8]>>7&1,t.CommCommand1=r[9],t.CommCommand2=r[10],t.CommCommandBufferStatus=r[11],t.DataOutBufferStatus=r[12],t.DataInBufferStatus=r[13],r[16]&&(t.ResultRegisters={},t.ResultRegisters.DetectKey=165===r[16],r[17]&&165!==r[17]&&(t.ResultRegisters.EOS=r[17]>>7&1,t.ResultRegisters.RDP=r[17]>>6&1,t.ResultRegisters.CRC=r[17]>>5&1,t.ResultRegisters.CMP=r[17]>>4&1,t.ResultRegisters.APP=r[17]>>2&1,t.ResultRegisters.SH=r[17]>>1&1,t.ResultRegisters.NRS=1&r[17]),t.ResultRegisters.Data=r.slice(16,r.length)),t};e.deviceGetStatus=function(){var r={direction:v.interrupt.direction,endpoint:v.interrupt.address,length:32};return e.bulkTransfer(r).then(function(e){return p(e.data)})},e.wireDetectShort=function(){return e.deviceGetStatus().then(function(e){return 0!==e.CommCommandBufferStatus?!0:e.ResultRegisters&&!e.ResultRegisters.DetectKey&&e.ResultRegisters.Data[0]&!0?!0:!1})},e.wireSetSpeed=function(r){var t="undefined"!=typeof r&&r?2:1,n={direction:"out",recipient:"device",requestType:"vendor",request:2,value:2,index:t,data:new Uint8Array(0).buffer};return e.controlTransfer(n)},e.wireReset=function(){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:3147,index:1,data:new Uint8Array(0).buffer};return e.controlTransfer(t).then(function(){var t=r.defer();return setTimeout(function(){e.wireDetectShort().then(function(e){e?t.reject():t.resolve()})},5),t.promise}).fail(function(){return e.deviceReset()}).fail(function(){throw new Error("Reset Failed: Unrecoverable short detected")})},e.wireWrite=function(r){var t={direction:v.bulkOut.direction,endpoint:v.bulkOut.address,data:new Uint8Array(r).buffer},n={direction:"out",recipient:"device",requestType:"vendor",request:1,value:4213,index:r.length,data:new Uint8Array(0).buffer,timeout:i};return e.bulkTransfer(t).then(function(){return e.controlTransfer(n)})},e.wireWriteBit=function(r){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:545|r<<3,index:0,data:new Uint8Array(0).buffer};return e.controlTransfer(t)},e.wireRead=function(r){var t={direction:v.bulkIn.direction,endpoint:v.bulkIn.address,length:r};return e.bulkTransfer(t).then(function(e){return new Uint8Array(e.data)})},e.wireReadBit=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:41,index:0,data:new Uint8Array(0).buffer};return e.controlTransfer(r).then(function(r){return e.wireRead(1)}).then(function(e){return e[0]})},e.wireClearByte=function(){return e.wireRead(1)},e.keyRomCommand=function(r,t,n){var i;n="undefined"!=typeof n&&n;var o={direction:v.bulkOut.direction,endpoint:v.bulkOut.address,data:new Uint8Array(8).buffer};"undefined"!=typeof r&&r?(o.data=new Uint8Array(t).buffer,i=n?105:85):i=n?60:204;var c={direction:"out",recipient:"device",requestType:"vendor",request:1,value:101,index:i,data:new Uint8Array(0).buffer};return e.controlTransfer(c).then(function(){return u=n,e.wireSetSpeed(n)}).then(function(){return e.bulkTransfer(o)})},e.keyRomMatch=function(r){return e.keyRomCommand(!0,r,!1)},e.keyRomMatchOverdrive=function(r){return e.keyRomCommand(!0,r,!0)},e.keyRomSkip=function(){return e.keyRomCommand(!1,null,!1)},e.keyRomSkipOverdrive=function(){return e.keyRomCommand(!1,null,!0)};var R={lastDiscrepancy:0,lastDevice:!1,keys:[]},w=function(e){var t=r.defer();return b(e).then(function(e){if(R=e,e.keys&&e.keys[0]){var r=e.keys[0];r.toHexString=function(){return S(this)},t.resolve(r)}else t.reject()}),t.promise};e.keySearchFirst=function(){var e={lastDiscrepancy:0,lastDevice:!1,keys:[]};return w(e)},e.keySearchNext=function(e){return w(R)};var b=function(r){var t={idBitNumber:1,lastZero:0,romByteNumber:0,romByteMask:1,searchResult:!1,idBit:0,cmpIdBit:0,searchDirection:0,romId:new Uint8Array(8),lastDevice:!1,lastDiscrepancy:r.lastDiscrepancy};return e.wireSetSpeed(!1).then(e.wireReset).then(function(){return e.wireWrite(new Uint8Array([240]))}).then(e.wireClearByte).then(function(){return k(t)}).then(function(e){return e.searchResult&&r.keys.push(e.romId),r.lastDiscrepancy=e.searchResultObject,r.lastDevice=e.lastDevice,r})},k=function(r){return e.wireReadBit().then(function(e){r.idBit=e}).then(function(){return e.wireReadBit()}).then(function(t){return r.cmpIdBit=t,1!==r.idBit||1!==r.cmpIdBit?(r.idBit!=r.cmpIdBit?r.searchDirection=r.idBit:(r.idBitNumber<r.lastDiscrepancy?r.searchDirection=(r.romId[r.romByteNumber]&r.romByteMask)>0?1:0:r.searchDirection=r.idBitNumber==r.lastDiscrepancy?1:0,0===r.searchDirection&&(r.lastZero=r.idBitNumber)),1===r.searchDirection?r.romId[r.romByteNumber]|=r.romByteMask:r.romId[r.romByteNumber]&=~r.romByteMask,e.wireWriteBit(r.searchDirection).then(function(){return r.idBitNumber++,r.romByteMask<<=1,r.romByteMask>=256&&(r.romByteNumber++,r.romByteMask=1),r.romByteNumber<8?k(r):(r.idBitNumber>=65&&0===n(r.romId)&&(r.lastDiscrepancy=r.lastZero,0===r.lastDiscrepancy&&(r.lastDevice=!0),r.searchResult=!0),(r.searchResult===!1||0===r.romId[0])&&(r.lastDiscrepancy=0,r.lastDevice=!1,r.searchResult=!1),r)})):r})};e.keyReadAll=function(r,t){return e.wireSetSpeed(!1).then(e.wireReset).then(function(){return"undefined"!=typeof t&&t?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([240,0,0]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(function(){return D()})};var D=function(r,t){if("undefined"==typeof t)var t=0;if("undefined"==typeof r)var r=new Array(256);r[t]=new Uint8Array(32);for(var n=new Uint8Array(32),i=0;i<n.length;i++)n[i]=255;return e.wireWrite(n).then(function(){return B(r[t])}).then(function(){return t<r.length-1?D(r,t+1):r})},B=function(r,t){if("undefined"==typeof t)var t=0;return e.wireRead(16).then(function(e){return e.forEach(function(e){r[t++]=e}),t<r.length?B(r,t):void 0})},S=function(e){const r=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var t="",n=Array.prototype.slice.call(e);return n.reverse().map(function(e){t+=r[e>>4&15]+r[15&e]}),t};return e};