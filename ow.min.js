module.exports=function(){"use strict";var e=require("q"),r=require("crc"),t={},n=function(e){return r.crc81wire(e)};const i=10,u=1274,o=9360,c={vendorId:u,productId:o},a={permissions:[{usbDevices:[c]}]};t.checkPermission=function(){var r=e.defer();return chrome.permissions.contains(a,function(e){e?r.resolve():r.reject()}),r.promise},t.requestPermission=function(){var r=e.defer();return chrome.permissions.request(a,function(e){e?r.resolve():r.reject()}),r.promise};var s,d,f;t.deviceOpen=function(){var r=e.defer();return chrome.usb.getDevices(c,function(e){chrome.usb.findDevices(c,function(t){t&&t.length>0?(d=t[0],s=e[0],chrome.usb.listInterfaces(d,function(e){f=e[0],v(),l().then(r.resolve)})):r.reject()})}),r.promise};var l=function(){var r=e.defer();return chrome.usb.claimInterface(d,f.interfaceNumber,r.resolve),r.promise},h={interrupt:{},bulkIn:{},bulkOut:{}},v=function(){f.endpoints.forEach(function(e){"in"===e.direction&&"interrupt"===e.type?h.interrupt=e:"in"===e.direction&&"bulk"===e.type?h.bulkIn=e:"out"===e.direction&&"bulk"===e.type&&(h.bulkOut=e)})},m=function(){this.handlers=[]};m.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},t.onDeviceAdded=new m,chrome.usb.onDeviceAdded.addListener(function(){t.onDeviceAdded.dispatch()});var y=function(){this.handlers=[]};y.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},t.onDeviceRemoved=new y,chrome.usb.onDeviceRemoved.addListener(function(e){e&&(s||{}).device&&e.device===s.device&&t.onDeviceRemoved.dispatch()}),t.deviceInterruptTransfer=function(){var r=e.defer(),t={direction:h.interrupt.direction,endpoint:h.interrupt.address,length:32,timeout:i};return chrome.usb.interruptTransfer(d,t,function(e){e.resultCode?r.reject(chrome.runtime.lastError):r.resolve(p(e.data))}),r.promise},t.deviceControlTransfer=function(r){var t=e.defer();return r.timeout=i,chrome.usb.controlTransfer(d,r,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},t.deviceBulkTransfer=function(r){var t=e.defer();return r.timeout=i,chrome.usb.bulkTransfer(d,r,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},t.deviceReset=function(){var e={direction:"out",recipient:"device",requestType:"vendor",request:0,value:0,index:0,data:new Uint8Array(0).buffer};return t.deviceControlTransfer(e).then(t.wireDetectShort).then(function(e){if(e)throw new Error("Reset Failed: Short Detected")})};var p=function(e){var r=new Uint8Array(e),t={};return t.SPUE=1&r[0],t.SPCE=r[0]>>3&1,t.Speed=r[1],t.PullupDuration=r[2],t.PulldownSlewRate=r[4],t.WriteLowTime=r[5],t.DataSampleOffset=r[6],t.SPUA=1&r[8],t.PMOD=r[8]>>3&1,t.HALT=r[8]>>4&1,t.IDLE=r[8]>>5&1,t.EP0F=r[8]>>7&1,t.CommCommand1=r[9],t.CommCommand2=r[10],t.CommCommandBufferStatus=r[11],t.DataOutBufferStatus=r[12],t.DataInBufferStatus=r[13],r[16]&&(t.ResultRegisters={},t.ResultRegisters.DetectKey=165===r[16],r[17]&&165!==r[17]&&(t.ResultRegisters.EOS=r[17]>>7&1,t.ResultRegisters.RDP=r[17]>>6&1,t.ResultRegisters.CRC=r[17]>>5&1,t.ResultRegisters.CMP=r[17]>>4&1,t.ResultRegisters.APP=r[17]>>2&1,t.ResultRegisters.SH=r[17]>>1&1,t.ResultRegisters.NRS=1&r[17]),t.ResultRegisters.Data=r.slice(16,r.length)),t};t.deviceGetStatus=function(){var e={direction:h.interrupt.direction,endpoint:h.interrupt.address,length:32};return t.deviceBulkTransfer(e).then(function(e){return p(e.data)})},t.wireDetectShort=function(){return t.deviceGetStatus().then(function(e){return 0!==e.CommCommandBufferStatus?!0:e.ResultRegisters&&!e.ResultRegisters.DetectKey&&e.ResultRegisters.Data[0]&!0?!0:!1})},t.wireSetSpeed=function(e){var r=e?2:1,n={direction:"out",recipient:"device",requestType:"vendor",request:2,value:2,index:r,data:new Uint8Array(0).buffer};return t.deviceControlTransfer(n)},t.wireReset=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:3147,index:1,data:new Uint8Array(0).buffer};return t.deviceControlTransfer(r).then(function(){var r=e.defer();return setTimeout(function(){t.wireDetectShort().then(function(e){e?r.reject():r.resolve()})},5),r.promise}).fail(function(){return t.deviceReset()}).fail(function(){throw new Error("Reset Failed: Unrecoverable short detected")})},t.wireWrite=function(e){var r={direction:h.bulkOut.direction,endpoint:h.bulkOut.address,data:new Uint8Array(e).buffer},n={direction:"out",recipient:"device",requestType:"vendor",request:1,value:4213,index:e.length,data:new Uint8Array(0).buffer,timeout:i};return t.deviceBulkTransfer(r).then(function(){return t.deviceControlTransfer(n)})},t.wireWriteBit=function(e){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:545|e<<3,index:0,data:new Uint8Array(0).buffer};return t.deviceControlTransfer(r)},t.wireRead=function(e){var r={direction:h.bulkIn.direction,endpoint:h.bulkIn.address,length:e};return t.deviceBulkTransfer(r).then(function(e){return new Uint8Array(e.data)})},t.wireReadBit=function(){var e={direction:"out",recipient:"device",requestType:"vendor",request:1,value:41,index:0,data:new Uint8Array(0).buffer};return t.deviceControlTransfer(e).then(function(e){return t.wireRead(1)}).then(function(e){return e[0]})},t.wireClearByte=function(){return t.wireRead(1)},t.keyRomCommand=function(e,r,n){var i,n=n||!1,u={direction:h.bulkOut.direction,endpoint:h.bulkOut.address,data:new Uint8Array(8).buffer};e?(u.data=new Uint8Array(r).buffer,i=n?105:85):i=n?60:204;var o={direction:"out",recipient:"device",requestType:"vendor",request:1,value:101,index:i,data:new Uint8Array(0).buffer};return t.deviceControlTransfer(o).then(function(){return t.wireSetSpeed(n)}).then(function(){return t.deviceBulkTransfer(u)})},t.keyRomMatch=function(e){return t.keyRomCommand(!0,e,!1)},t.keyRomMatchOverdrive=function(e){return t.keyRomCommand(!0,e,!0)},t.keyRomSkip=function(){return t.keyRomCommand(!1,null,!1)},t.keyRomSkipOverdrive=function(){return t.keyRomCommand(!1,null,!0)};var w={lastDiscrepancy:0,lastDevice:!1,keys:[]},R=function(r){var t=e.defer();return k(r).then(function(e){if(w=e,e.keys&&e.keys[0]){var r=e.keys[0];r.toHexString=function(){return T(this)},t.resolve(r)}else t.reject()}),t.promise};t.keySearchFirst=function(){var e={lastDiscrepancy:0,lastDevice:!1,keys:[]};return R(e)},t.keySearchNext=function(e){return R(w)};var k=function(e){var r={idBitNumber:1,lastZero:0,romByteNumber:0,romByteMask:1,searchResult:!1,idBit:0,cmpIdBit:0,searchDirection:0,romId:new Uint8Array(8),lastDevice:!1,lastDiscrepancy:e.lastDiscrepancy};return t.wireSetSpeed(!1).then(t.wireReset).then(function(){return t.wireWrite(new Uint8Array([240]))}).then(t.wireClearByte).then(function(){return B(r)}).then(function(r){return r.searchResult&&e.keys.push(r.romId),e.lastDiscrepancy=r.searchResultObject,e.lastDevice=r.lastDevice,e})},B=function(e){return t.wireReadBit().then(function(r){e.idBit=r}).then(function(){return t.wireReadBit()}).then(function(r){return e.cmpIdBit=r,1!==e.idBit||1!==e.cmpIdBit?(e.idBit!=e.cmpIdBit?e.searchDirection=e.idBit:(e.idBitNumber<e.lastDiscrepancy?e.searchDirection=(e.romId[e.romByteNumber]&e.romByteMask)>0?1:0:e.searchDirection=e.idBitNumber==e.lastDiscrepancy?1:0,0===e.searchDirection&&(e.lastZero=e.idBitNumber)),1===e.searchDirection?e.romId[e.romByteNumber]|=e.romByteMask:e.romId[e.romByteNumber]&=~e.romByteMask,t.wireWriteBit(e.searchDirection).then(function(){return e.idBitNumber++,e.romByteMask<<=1,e.romByteMask>=256&&(e.romByteNumber++,e.romByteMask=1),e.romByteNumber<8?B(e):(e.idBitNumber>=65&&0===n(e.romId)&&(e.lastDiscrepancy=e.lastZero,0===e.lastDiscrepancy&&(e.lastDevice=!0),e.searchResult=!0),(e.searchResult===!1||0===e.romId[0])&&(e.lastDiscrepancy=0,e.lastDevice=!1,e.searchResult=!1),e)})):e})};t.keyReadAll=function(e,r){return t.wireSetSpeed(!1).then(t.wireReset).then(function(){return r?t.keyRomMatchOverdrive(e):t.keyRomMatch(e)}).then(function(){var e=new Uint8Array([240,0,0]);return t.wireWrite(e)}).then(t.wireClearByte).then(t.wireClearByte).then(t.wireClearByte).then(function(){return D()})};var D=function(e,r){var r=r||0,e=e||new Array(256);e[r]=new Uint8Array(32);for(var n=new Uint8Array(32),i=0;i<n.length;i++)n[i]=255;return t.wireWrite(n).then(function(){return b(e[r])}).then(function(){return r<e.length-1?D(e,r+1):e})},b=function(e,r){var r=r||0;return t.wireRead(16).then(function(t){return t.forEach(function(t){e[r++]=t}),r<e.length?b(e,r):void 0})};t.keyWrite=function(e,r,n,i){var r=r||0,u=255&r,o=(65280&r)>>8,c=n.length-1,n=n||new Uint8Array(0);return t.wireSetSpeed(!1).then(function(){return C(e,r,n,i)}).then(t.wireReset).then(function(){return i?t.keyRomMatchOverdrive(e):t.keyRomMatch(e)}).then(function(){var e=new Uint8Array([85,u,o,c]);return t.wireWrite(e)}).then(t.wireClearByte).then(t.wireClearByte).then(t.wireClearByte).then(t.wireClearByte)};var C=function(e,r,n,i){var u,r=r||0,o=255&r,c=(65280&r)>>8,n=(n.length-1,n||new Uint8Array(0));return t.wireReset().then(function(){return i?t.keyRomMatchOverdrive(e):t.keyRomMatch(e)}).then(function(){var e=new Uint8Array([15,o,c]);return t.wireWrite(e)}).then(t.wireClearByte).then(t.wireClearByte).then(t.wireClearByte).then(function(){return g(n,0)}).then(t.wireReset).then(function(){return i?t.keyRomMatchOverdrive(e):t.keyRomMatch(e)}).then(function(){var e=new Uint8Array([170]);return t.wireWrite(e)}).then(function(){return t.wireRead(n.length)}).then(function(e){u=e}).then(t.wireClearByte).then(function(){return u.length==n.length&&u.every(function(e,r){return e===n[r]})?void 0:C(e,r,n,i)})},g=function(e,r){for(var n=e.length-r>16?16:e.length-r,i=new Uint8Array(n),u=0;n>u;u++)i[u]=e[r+u];return t.wireWrite(i).then(function(){return e.length-(r+n)>0?g(e,r+n):void 0})};t.keyWriteAll=function(e,r,t){return A(e,r,0,t)};var A=function(e,r,n,i){var u=32*n;return t.keyWrite(e,u,r[n],i).then(function(){return r.length>n+1?A(e,r,n+1,i):void 0})};t.keyWriteDiff=function(e,r,n,i){return(n||new Array(0)).length<r.length?t.keyReadAll(e,i).then(function(t){return S(e,r,t,0,i)}):S(e,r,n,0,i)};var S=function(e,r,n,i,u){var o=32*i;return r[i].length===n[i].length&&r[i].every(function(e,r){return e===n[i][r]})&&r.length>i+1?S(e,r,n,i+1,u):t.keyWrite(e,o,r[i],u).then(function(){return r.length>i+1?S(e,r,n,i+1,u):void 0})},T=function(e){const r=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var t="",n=Array.prototype.slice.call(e);return n.reverse().map(function(e){t+=r[e>>4&15]+r[15&e]}),t};return t}();