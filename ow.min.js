"use strict";module.exports=function(e){var t=require("q");if("undefined"==typeof e)var e={};var r=1274,n=9360,i={vendorId:r,productId:n},s={permissions:[{usbDevices:[i]}]};e.checkPermission=function(){var e=t.defer();return chrome.permissions.contains(s,function(t){t?e.resolve():e.reject()}),e.promise},e.requestPermission=function(){var e=t.defer();return chrome.permissions.request(s,function(t){t?e.resolve():e.reject()}),e.promise};var o,u,c;e.openDevice=function(){var e=t.defer();return chrome.usb.getDevices(i,function(t){chrome.usb.findDevices(i,function(r){r&&r.length>0?(u=r[0],o=t[0],chrome.usb.listInterfaces(u,function(t){c=t[0],f(),a().then(e.resolve)})):e.reject()})}),e.promise};var a=function(){var e=t.defer();return chrome.usb.claimInterface(u,c.interfaceNumber,e.resolve),e.promise},d={interrupt:{},"in":{},out:{}},f=function(){c.endpoints.forEach(function(e){"in"==e.direction&&"interrupt"==e.type?d.interrupt=e:"in"==e.direction&&"bulk"==e.type?d["in"]=e:"out"==e.direction&&"bulk"==e.type&&(d.out=e)})},m=function(){this.handlers=[]};m.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(t){return t!==e?t:void 0})},dispatch:function(e,t){var r=t||window;this.handlers.forEach(function(t){t.call(r,e)})}},e.onDeviceRemoved=new m,chrome.usb.onDeviceRemoved.addListener(function(t){t.device==o.device&&e.onDeviceRemoved.dispatch()}),e.interrupt=function(){var e=t.defer(),r={direction:d.interrupt.direction,endpoint:d.interrupt.address,length:18};return chrome.usb.interruptTransfer(u,r,function(t){t.resultCode?e.reject():e.resolve(l(t.data))}),e.promise};var l=function(e){var t=new Uint8Array(e),r={};return r.SPUE=1&t[0],r.SPCE=t[0]>>3&1,r.Speed=t[1],r.PullupDuration=t[2],r.PulldownSlewRate=t[4],r.WriteLowTime=t[5],r.DataSampleOffset=t[6],r.SPUA=1&t[8],r.PMOD=t[8]>>3&1,r.HALT=t[8]>>4&1,r.IDLE=t[8]>>5&1,r.EP0F=t[8]>>7&1,r.CommCommand1=t[9],r.CommCommand2=t[10],r.CommCommandBufferStatus=t[11],r.DataOutBufferStatus=t[12],r.DataInBufferStatus=t[13],t[16]&&(r.ResultRegisters={},r.ResultRegisters.DetectKey=165==t[16],t[17]&&165!=t[17]&&(r.ResultRegisters.EOS=t[17]>>7&1,r.ResultRegisters.RDP=t[17]>>6&1,r.ResultRegisters.CRC=t[17]>>5&1,r.ResultRegisters.CMP=t[17]>>4&1,r.ResultRegisters.APP=t[17]>>2&1,r.ResultRegisters.SH=t[17]>>1&1,r.ResultRegisters.NRS=1&t[17])),r};return e};