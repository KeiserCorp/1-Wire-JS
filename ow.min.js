module.exports=function(e){"use strict";var r=require("q"),t=require("./node_modules/crc/lib/crc8_1wire.js"),e=e||{};const n=10;var i=!1;const u=1274,o=9360,c={vendorId:u,productId:o},a={permissions:[{usbDevices:[c]}]};e.checkPermission=function(){var e=r.defer();return chrome.permissions.contains(a,function(r){r?e.resolve():e.reject()}),e.promise},e.requestPermission=function(){var e=r.defer();return chrome.permissions.request(a,function(r){r?e.resolve():e.reject()}),e.promise};var s,d,f;e.deviceOpen=function(){var e=r.defer();return chrome.usb.getDevices(c,function(r){chrome.usb.findDevices(c,function(t){t&&t.length>0?(d=t[0],s=r[0],chrome.usb.listInterfaces(d,function(r){f=r[0],v(),l().then(e.resolve)})):e.reject()})}),e.promise};var l=function(){var e=r.defer();return chrome.usb.claimInterface(d,f.interfaceNumber,e.resolve),e.promise},h={interrupt:{},bulkIn:{},bulkOut:{}},v=function(){f.endpoints.forEach(function(e){"in"===e.direction&&"interrupt"===e.type?h.interrupt=e:"in"===e.direction&&"bulk"===e.type?h.bulkIn=e:"out"===e.direction&&"bulk"===e.type&&(h.bulkOut=e)})},m=function(){this.handlers=[]};m.prototype={addListener:function(e){this.handlers.push(e)},addedListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},e.onDeviceAdded=new m,chrome.usb.onDeviceAdded.addListener(function(){e.onDeviceAdded.dispatch()});var y=function(){this.handlers=[]};y.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},e.onDeviceRemoved=new y,chrome.usb.onDeviceRemoved.addListener(function(r){r&&r.device===s.device&&e.onDeviceRemoved.dispatch()}),e.deviceInterruptTransfer=function(){var e=r.defer(),t={direction:h.interrupt.direction,endpoint:h.interrupt.address,length:32,timeout:n};return chrome.usb.interruptTransfer(d,t,function(r){r.resultCode?e.reject(chrome.runtime.lastError):e.resolve(p(r.data))}),e.promise},e.deviceControlTransfer=function(e){var t=r.defer();return e.timeout=n,chrome.usb.controlTransfer(d,e,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},e.deviceBulkTransfer=function(e){var t=r.defer();return e.timeout=n,chrome.usb.bulkTransfer(d,e,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},e.deviceReset=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:0,value:0,index:0,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(r).then(e.wireDetectShort).then(function(e){if(e)throw new Error("Reset Failed: Short Detected")})};var p=function(e){var r=new Uint8Array(e),t={};return t.SPUE=1&r[0],t.SPCE=r[0]>>3&1,t.Speed=r[1],t.PullupDuration=r[2],t.PulldownSlewRate=r[4],t.WriteLowTime=r[5],t.DataSampleOffset=r[6],t.SPUA=1&r[8],t.PMOD=r[8]>>3&1,t.HALT=r[8]>>4&1,t.IDLE=r[8]>>5&1,t.EP0F=r[8]>>7&1,t.CommCommand1=r[9],t.CommCommand2=r[10],t.CommCommandBufferStatus=r[11],t.DataOutBufferStatus=r[12],t.DataInBufferStatus=r[13],r[16]&&(t.ResultRegisters={},t.ResultRegisters.DetectKey=165===r[16],r[17]&&165!==r[17]&&(t.ResultRegisters.EOS=r[17]>>7&1,t.ResultRegisters.RDP=r[17]>>6&1,t.ResultRegisters.CRC=r[17]>>5&1,t.ResultRegisters.CMP=r[17]>>4&1,t.ResultRegisters.APP=r[17]>>2&1,t.ResultRegisters.SH=r[17]>>1&1,t.ResultRegisters.NRS=1&r[17]),t.ResultRegisters.Data=r.slice(16,r.length)),t};e.deviceGetStatus=function(){var r={direction:h.interrupt.direction,endpoint:h.interrupt.address,length:32};return e.deviceBulkTransfer(r).then(function(e){return p(e.data)})},e.wireDetectShort=function(){return e.deviceGetStatus().then(function(e){return 0!==e.CommCommandBufferStatus?!0:e.ResultRegisters&&!e.ResultRegisters.DetectKey&&e.ResultRegisters.Data[0]&!0?!0:!1})},e.wireSetSpeed=function(r){var t=r?2:1,n={direction:"out",recipient:"device",requestType:"vendor",request:2,value:2,index:t,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(n)},e.wireReset=function(){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:3147,index:1,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(t).then(function(){var t=r.defer();return setTimeout(function(){e.wireDetectShort().then(function(e){e?t.reject():t.resolve()})},5),t.promise}).fail(function(){return e.deviceReset()}).fail(function(){throw new Error("Reset Failed: Unrecoverable short detected")})},e.wireWrite=function(r){var t={direction:h.bulkOut.direction,endpoint:h.bulkOut.address,data:new Uint8Array(r).buffer},i={direction:"out",recipient:"device",requestType:"vendor",request:1,value:4213,index:r.length,data:new Uint8Array(0).buffer,timeout:n};return e.deviceBulkTransfer(t).then(function(){return e.deviceControlTransfer(i)})},e.wireWriteBit=function(r){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:545|r<<3,index:0,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(t)},e.wireRead=function(r){var t={direction:h.bulkIn.direction,endpoint:h.bulkIn.address,length:r};return e.deviceBulkTransfer(t).then(function(e){return new Uint8Array(e.data)})},e.wireReadBit=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:41,index:0,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(r).then(function(r){return e.wireRead(1)}).then(function(e){return e[0]})},e.wireClearByte=function(){return e.wireRead(1)},e.keyRomCommand=function(r,t,n){var u,n=n||!1,o={direction:h.bulkOut.direction,endpoint:h.bulkOut.address,data:new Uint8Array(8).buffer};r?(o.data=new Uint8Array(t).buffer,u=n?105:85):u=n?60:204;var c={direction:"out",recipient:"device",requestType:"vendor",request:1,value:101,index:u,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(c).then(function(){return i=n,e.wireSetSpeed(n)}).then(function(){return e.deviceBulkTransfer(o)})},e.keyRomMatch=function(r){return e.keyRomCommand(!0,r,!1)},e.keyRomMatchOverdrive=function(r){return e.keyRomCommand(!0,r,!0)},e.keyRomSkip=function(){return e.keyRomCommand(!1,null,!1)},e.keyRomSkipOverdrive=function(){return e.keyRomCommand(!1,null,!0)};var w={lastDiscrepancy:0,lastDevice:!1,keys:[]},R=function(e){var t=r.defer();return k(e).then(function(e){if(w=e,e.keys&&e.keys[0]){var r=e.keys[0];r.toHexString=function(){return T(this)},t.resolve(r)}else t.reject()}),t.promise};e.keySearchFirst=function(){var e={lastDiscrepancy:0,lastDevice:!1,keys:[]};return R(e)},e.keySearchNext=function(e){return R(w)};var k=function(r){var t={idBitNumber:1,lastZero:0,romByteNumber:0,romByteMask:1,searchResult:!1,idBit:0,cmpIdBit:0,searchDirection:0,romId:new Uint8Array(8),lastDevice:!1,lastDiscrepancy:r.lastDiscrepancy};return e.wireSetSpeed(!1).then(e.wireReset).then(function(){return e.wireWrite(new Uint8Array([240]))}).then(e.wireClearByte).then(function(){return B(t)}).then(function(e){return e.searchResult&&r.keys.push(e.romId),r.lastDiscrepancy=e.searchResultObject,r.lastDevice=e.lastDevice,r})},B=function(r){return e.wireReadBit().then(function(e){r.idBit=e}).then(function(){return e.wireReadBit()}).then(function(n){return r.cmpIdBit=n,1!==r.idBit||1!==r.cmpIdBit?(r.idBit!=r.cmpIdBit?r.searchDirection=r.idBit:(r.idBitNumber<r.lastDiscrepancy?r.searchDirection=(r.romId[r.romByteNumber]&r.romByteMask)>0?1:0:r.searchDirection=r.idBitNumber==r.lastDiscrepancy?1:0,0===r.searchDirection&&(r.lastZero=r.idBitNumber)),1===r.searchDirection?r.romId[r.romByteNumber]|=r.romByteMask:r.romId[r.romByteNumber]&=~r.romByteMask,e.wireWriteBit(r.searchDirection).then(function(){return r.idBitNumber++,r.romByteMask<<=1,r.romByteMask>=256&&(r.romByteNumber++,r.romByteMask=1),r.romByteNumber<8?B(r):(r.idBitNumber>=65&&0===t(r.romId)&&(r.lastDiscrepancy=r.lastZero,0===r.lastDiscrepancy&&(r.lastDevice=!0),r.searchResult=!0),(r.searchResult===!1||0===r.romId[0])&&(r.lastDiscrepancy=0,r.lastDevice=!1,r.searchResult=!1),r)})):r})};e.keyReadAll=function(r,t){return e.wireSetSpeed(!1).then(e.wireReset).then(function(){return t?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([240,0,0]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(function(){return D()})};var D=function(r,t){var t=t||0,r=r||new Array(256);r[t]=new Uint8Array(32);for(var n=new Uint8Array(32),i=0;i<n.length;i++)n[i]=255;return e.wireWrite(n).then(function(){return b(r[t])}).then(function(){return t<r.length-1?D(r,t+1):r})},b=function(r,t){var t=t||0;return e.wireRead(16).then(function(e){return e.forEach(function(e){r[t++]=e}),t<r.length?b(r,t):void 0})};e.keyWrite=function(r,t,n,i){var t=t||0,u=255&t,o=(65280&t)>>8,c=n.length-1,n=n||new Uint8Array(0);return e.wireSetSpeed(!1).then(function(){return C(r,t,n,i)}).then(e.wireReset).then(function(){return i?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([85,u,o,c]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte)};var C=function(r,t,n,i){var u,t=t||0,o=255&t,c=(65280&t)>>8,n=(n.length-1,n||new Uint8Array(0));return e.wireReset().then(function(){return i?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([15,o,c]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(function(){return g(n,0)}).then(e.wireReset).then(function(){return i?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([170]);return e.wireWrite(r)}).then(function(){return e.wireRead(n.length)}).then(function(e){u=e}).then(e.wireClearByte).then(function(){return u.length==n.length&&u.every(function(e,r){return e===n[r]})?void 0:C(r,t,n,i)})},g=function(r,t){for(var n=r.length-t>16?16:r.length-t,i=new Uint8Array(n),u=0;n>u;u++)i[u]=r[t+u];return e.wireWrite(i).then(function(){return r.length-(t+n)>0?g(r,t+n):void 0})};e.keyWriteAll=function(e,r,t){return A(e,r,0,t)};var A=function(r,t,n,i){var u=32*n;return e.keyWrite(r,u,t[n],i).then(function(){return t.length>n+1?A(r,t,n+1,i):void 0})};e.keyWriteDiff=function(r,t,n,i){return(n||new Array(0)).length<t.length?e.keyReadAll(r,i).then(function(e){return S(r,t,e,0,i)}):S(r,t,n,0,i)};var S=function(r,t,n,i,u){var o=32*i;return t[i].length===n[i].length&&t[i].every(function(e,r){return e===n[i][r]})&&t.length>i+1?S(r,t,n,i+1,u):e.keyWrite(r,o,t[i],u).then(function(){return t.length>i+1?S(r,t,n,i+1,u):void 0})},T=function(e){const r=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var t="",n=Array.prototype.slice.call(e);return n.reverse().map(function(e){t+=r[e>>4&15]+r[15&e]}),t};return e}();