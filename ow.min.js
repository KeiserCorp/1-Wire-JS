module.exports=function(e){"use strict";var r=require("q"),t=require("crc"),e=e||{},n=function(e){return t.crc81wire(e)};const i=10;var u=!1;const o=1274,c=9360,a={vendorId:o,productId:c},s={permissions:[{usbDevices:[a]}]};e.checkPermission=function(){var e=r.defer();return chrome.permissions.contains(s,function(r){r?e.resolve():e.reject()}),e.promise},e.requestPermission=function(){var e=r.defer();return chrome.permissions.request(s,function(r){r?e.resolve():e.reject()}),e.promise};var d,f,l;e.deviceOpen=function(){var e=r.defer();return chrome.usb.getDevices(a,function(r){chrome.usb.findDevices(a,function(t){t&&t.length>0?(f=t[0],d=r[0],chrome.usb.listInterfaces(f,function(r){l=r[0],m(),h().then(e.resolve)})):e.reject()})}),e.promise};var h=function(){var e=r.defer();return chrome.usb.claimInterface(f,l.interfaceNumber,e.resolve),e.promise},v={interrupt:{},bulkIn:{},bulkOut:{}},m=function(){l.endpoints.forEach(function(e){"in"===e.direction&&"interrupt"===e.type?v.interrupt=e:"in"===e.direction&&"bulk"===e.type?v.bulkIn=e:"out"===e.direction&&"bulk"===e.type&&(v.bulkOut=e)})},y=function(){this.handlers=[]};y.prototype={addListener:function(e){this.handlers.push(e)},addedListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},e.onDeviceAdded=new y,chrome.usb.onDeviceAdded.addListener(function(){e.onDeviceAdded.dispatch()});var p=function(){this.handlers=[]};p.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},e.onDeviceRemoved=new p,chrome.usb.onDeviceRemoved.addListener(function(r){r&&r.device===d.device&&e.onDeviceRemoved.dispatch()}),e.deviceInterruptTransfer=function(){var e=r.defer(),t={direction:v.interrupt.direction,endpoint:v.interrupt.address,length:32,timeout:i};return chrome.usb.interruptTransfer(f,t,function(r){r.resultCode?e.reject(chrome.runtime.lastError):e.resolve(w(r.data))}),e.promise},e.deviceControlTransfer=function(e){var t=r.defer();return e.timeout=i,chrome.usb.controlTransfer(f,e,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},e.deviceBulkTransfer=function(e){var t=r.defer();return e.timeout=i,chrome.usb.bulkTransfer(f,e,function(e){e.resultCode?t.reject(chrome.runtime.lastError):t.resolve(e)}),t.promise},e.deviceReset=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:0,value:0,index:0,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(r).then(e.wireDetectShort).then(function(e){if(e)throw new Error("Reset Failed: Short Detected")})};var w=function(e){var r=new Uint8Array(e),t={};return t.SPUE=1&r[0],t.SPCE=r[0]>>3&1,t.Speed=r[1],t.PullupDuration=r[2],t.PulldownSlewRate=r[4],t.WriteLowTime=r[5],t.DataSampleOffset=r[6],t.SPUA=1&r[8],t.PMOD=r[8]>>3&1,t.HALT=r[8]>>4&1,t.IDLE=r[8]>>5&1,t.EP0F=r[8]>>7&1,t.CommCommand1=r[9],t.CommCommand2=r[10],t.CommCommandBufferStatus=r[11],t.DataOutBufferStatus=r[12],t.DataInBufferStatus=r[13],r[16]&&(t.ResultRegisters={},t.ResultRegisters.DetectKey=165===r[16],r[17]&&165!==r[17]&&(t.ResultRegisters.EOS=r[17]>>7&1,t.ResultRegisters.RDP=r[17]>>6&1,t.ResultRegisters.CRC=r[17]>>5&1,t.ResultRegisters.CMP=r[17]>>4&1,t.ResultRegisters.APP=r[17]>>2&1,t.ResultRegisters.SH=r[17]>>1&1,t.ResultRegisters.NRS=1&r[17]),t.ResultRegisters.Data=r.slice(16,r.length)),t};e.deviceGetStatus=function(){var r={direction:v.interrupt.direction,endpoint:v.interrupt.address,length:32};return e.deviceBulkTransfer(r).then(function(e){return w(e.data)})},e.wireDetectShort=function(){return e.deviceGetStatus().then(function(e){return 0!==e.CommCommandBufferStatus?!0:e.ResultRegisters&&!e.ResultRegisters.DetectKey&&e.ResultRegisters.Data[0]&!0?!0:!1})},e.wireSetSpeed=function(r){var t=r?2:1,n={direction:"out",recipient:"device",requestType:"vendor",request:2,value:2,index:t,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(n)},e.wireReset=function(){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:3147,index:1,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(t).then(function(){var t=r.defer();return setTimeout(function(){e.wireDetectShort().then(function(e){e?t.reject():t.resolve()})},5),t.promise}).fail(function(){return e.deviceReset()}).fail(function(){throw new Error("Reset Failed: Unrecoverable short detected")})},e.wireWrite=function(r){var t={direction:v.bulkOut.direction,endpoint:v.bulkOut.address,data:new Uint8Array(r).buffer},n={direction:"out",recipient:"device",requestType:"vendor",request:1,value:4213,index:r.length,data:new Uint8Array(0).buffer,timeout:i};return e.deviceBulkTransfer(t).then(function(){return e.deviceControlTransfer(n)})},e.wireWriteBit=function(r){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:545|r<<3,index:0,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(t)},e.wireRead=function(r){var t={direction:v.bulkIn.direction,endpoint:v.bulkIn.address,length:r};return e.deviceBulkTransfer(t).then(function(e){return new Uint8Array(e.data)})},e.wireReadBit=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:41,index:0,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(r).then(function(r){return e.wireRead(1)}).then(function(e){return e[0]})},e.wireClearByte=function(){return e.wireRead(1)},e.keyRomCommand=function(r,t,n){var i,n=n||!1,o={direction:v.bulkOut.direction,endpoint:v.bulkOut.address,data:new Uint8Array(8).buffer};r?(o.data=new Uint8Array(t).buffer,i=n?105:85):i=n?60:204;var c={direction:"out",recipient:"device",requestType:"vendor",request:1,value:101,index:i,data:new Uint8Array(0).buffer};return e.deviceControlTransfer(c).then(function(){return u=n,e.wireSetSpeed(n)}).then(function(){return e.deviceBulkTransfer(o)})},e.keyRomMatch=function(r){return e.keyRomCommand(!0,r,!1)},e.keyRomMatchOverdrive=function(r){return e.keyRomCommand(!0,r,!0)},e.keyRomSkip=function(){return e.keyRomCommand(!1,null,!1)},e.keyRomSkipOverdrive=function(){return e.keyRomCommand(!1,null,!0)};var R={lastDiscrepancy:0,lastDevice:!1,keys:[]},k=function(e){var t=r.defer();return B(e).then(function(e){if(R=e,e.keys&&e.keys[0]){var r=e.keys[0];r.toHexString=function(){return U(this)},t.resolve(r)}else t.reject()}),t.promise};e.keySearchFirst=function(){var e={lastDiscrepancy:0,lastDevice:!1,keys:[]};return k(e)},e.keySearchNext=function(e){return k(R)};var B=function(r){var t={idBitNumber:1,lastZero:0,romByteNumber:0,romByteMask:1,searchResult:!1,idBit:0,cmpIdBit:0,searchDirection:0,romId:new Uint8Array(8),lastDevice:!1,lastDiscrepancy:r.lastDiscrepancy};return e.wireSetSpeed(!1).then(e.wireReset).then(function(){return e.wireWrite(new Uint8Array([240]))}).then(e.wireClearByte).then(function(){return D(t)}).then(function(e){return e.searchResult&&r.keys.push(e.romId),r.lastDiscrepancy=e.searchResultObject,r.lastDevice=e.lastDevice,r})},D=function(r){return e.wireReadBit().then(function(e){r.idBit=e}).then(function(){return e.wireReadBit()}).then(function(t){return r.cmpIdBit=t,1!==r.idBit||1!==r.cmpIdBit?(r.idBit!=r.cmpIdBit?r.searchDirection=r.idBit:(r.idBitNumber<r.lastDiscrepancy?r.searchDirection=(r.romId[r.romByteNumber]&r.romByteMask)>0?1:0:r.searchDirection=r.idBitNumber==r.lastDiscrepancy?1:0,0===r.searchDirection&&(r.lastZero=r.idBitNumber)),1===r.searchDirection?r.romId[r.romByteNumber]|=r.romByteMask:r.romId[r.romByteNumber]&=~r.romByteMask,e.wireWriteBit(r.searchDirection).then(function(){return r.idBitNumber++,r.romByteMask<<=1,r.romByteMask>=256&&(r.romByteNumber++,r.romByteMask=1),r.romByteNumber<8?D(r):(r.idBitNumber>=65&&0===n(r.romId)&&(r.lastDiscrepancy=r.lastZero,0===r.lastDiscrepancy&&(r.lastDevice=!0),r.searchResult=!0),(r.searchResult===!1||0===r.romId[0])&&(r.lastDiscrepancy=0,r.lastDevice=!1,r.searchResult=!1),r)})):r})};e.keyReadAll=function(r,t){return e.wireSetSpeed(!1).then(e.wireReset).then(function(){return t?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([240,0,0]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(function(){return b()})};var b=function(r,t){var t=t||0,r=r||new Array(256);r[t]=new Uint8Array(32);for(var n=new Uint8Array(32),i=0;i<n.length;i++)n[i]=255;return e.wireWrite(n).then(function(){return C(r[t])}).then(function(){return t<r.length-1?b(r,t+1):r})},C=function(r,t){var t=t||0;return e.wireRead(16).then(function(e){return e.forEach(function(e){r[t++]=e}),t<r.length?C(r,t):void 0})};e.keyWrite=function(r,t,n,i){var t=t||0,u=255&t,o=(65280&t)>>8,c=n.length-1,n=n||new Uint8Array(0);return e.wireSetSpeed(!1).then(function(){return g(r,t,n,i)}).then(e.wireReset).then(function(){return i?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([85,u,o,c]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte)};var g=function(r,t,n,i){var u,t=t||0,o=255&t,c=(65280&t)>>8,n=(n.length-1,n||new Uint8Array(0));return e.wireReset().then(function(){return i?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([15,o,c]);return e.wireWrite(r)}).then(e.wireClearByte).then(e.wireClearByte).then(e.wireClearByte).then(function(){return A(n,0)}).then(e.wireReset).then(function(){return i?e.keyRomMatchOverdrive(r):e.keyRomMatch(r)}).then(function(){var r=new Uint8Array([170]);return e.wireWrite(r)}).then(function(){return e.wireRead(n.length)}).then(function(e){u=e}).then(e.wireClearByte).then(function(){return u.length==n.length&&u.every(function(e,r){return e===n[r]})?void 0:g(r,t,n,i)})},A=function(r,t){for(var n=r.length-t>16?16:r.length-t,i=new Uint8Array(n),u=0;n>u;u++)i[u]=r[t+u];return e.wireWrite(i).then(function(){return r.length-(t+n)>0?A(r,t+n):void 0})};e.keyWriteAll=function(e,r,t){return S(e,r,0,t)};var S=function(r,t,n,i){var u=32*n;return e.keyWrite(r,u,t[n],i).then(function(){return t.length>n+1?S(r,t,n+1,i):void 0})};e.keyWriteDiff=function(r,t,n,i){return(n||new Array(0)).length<t.length?e.keyReadAll(r,i).then(function(e){return T(r,t,e,0,i)}):T(r,t,n,0,i)};var T=function(r,t,n,i,u){var o=32*i;return t[i].length===n[i].length&&t[i].every(function(e,r){return e===n[i][r]})&&t.length>i+1?T(r,t,n,i+1,u):e.keyWrite(r,o,t[i],u).then(function(){return t.length>i+1?T(r,t,n,i+1,u):void 0})},U=function(e){const r=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var t="",n=Array.prototype.slice.call(e);return n.reverse().map(function(e){t+=r[e>>4&15]+r[15&e]}),t};return e}();