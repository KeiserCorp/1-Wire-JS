module.exports=function(e){"use strict";var r=require("q"),t=require("crc");if("undefined"==typeof e)var e={};var n=function(e){return t.crc81wire(e)};const i=1274,s=9360,u={vendorId:i,productId:s},o={permissions:[{usbDevices:[u]}]};e.checkPermission=function(){var e=r.defer();return chrome.permissions.contains(o,function(r){r?e.resolve():e.reject()}),e.promise},e.requestPermission=function(){var e=r.defer();return chrome.permissions.request(o,function(r){r?e.resolve():e.reject()}),e.promise};var c,a,d;e.openDevice=function(){var e=r.defer();return chrome.usb.getDevices(u,function(r){chrome.usb.findDevices(u,function(t){t&&t.length>0?(a=t[0],c=r[0],chrome.usb.listInterfaces(a,function(r){d=r[0],m(),f().then(e.resolve)})):e.reject()})}),e.promise};var f=function(){var e=r.defer();return chrome.usb.claimInterface(a,d.interfaceNumber,e.resolve),e.promise},l={interrupt:{},bulkIn:{},bulkOut:{}},m=function(){d.endpoints.forEach(function(e){"in"===e.direction&&"interrupt"===e.type?l.interrupt=e:"in"===e.direction&&"bulk"===e.type?l.bulkIn=e:"out"===e.direction&&"bulk"===e.type&&(l.bulkOut=e)})},v=function(){this.handlers=[]};v.prototype={addListener:function(e){this.handlers.push(e)},removeListener:function(e){this.handlers=this.handlers.filter(function(r){return r!==e?r:void 0})},dispatch:function(e,r){var t=r;this.handlers.forEach(function(r){r.call(t,e)})}},e.onDeviceRemoved=new v,chrome.usb.onDeviceRemoved.addListener(function(r){r.device===c.device&&e.onDeviceRemoved.dispatch()});var y=function(e){var r=new Uint8Array(e),t={};return t.SPUE=1&r[0],t.SPCE=r[0]>>3&1,t.Speed=r[1],t.PullupDuration=r[2],t.PulldownSlewRate=r[4],t.WriteLowTime=r[5],t.DataSampleOffset=r[6],t.SPUA=1&r[8],t.PMOD=r[8]>>3&1,t.HALT=r[8]>>4&1,t.IDLE=r[8]>>5&1,t.EP0F=r[8]>>7&1,t.CommCommand1=r[9],t.CommCommand2=r[10],t.CommCommandBufferStatus=r[11],t.DataOutBufferStatus=r[12],t.DataInBufferStatus=r[13],r[16]&&(t.ResultRegisters={},t.ResultRegisters.DetectKey=165===r[16],r[17]&&165!==r[17]&&(t.ResultRegisters.EOS=r[17]>>7&1,t.ResultRegisters.RDP=r[17]>>6&1,t.ResultRegisters.CRC=r[17]>>5&1,t.ResultRegisters.CMP=r[17]>>4&1,t.ResultRegisters.APP=r[17]>>2&1,t.ResultRegisters.SH=r[17]>>1&1,t.ResultRegisters.NRS=1&r[17])),t};e.interruptTransfer=function(){var e=r.defer(),t={direction:l.interrupt.direction,endpoint:l.interrupt.address,length:18};return chrome.usb.interruptTransfer(a,t,function(r){r.resultCode?e.reject(r):e.resolve(y(r.data))}),e.promise},e.controlTransfer=function(e){var t=r.defer();return chrome.usb.controlTransfer(a,e,function(e){e.resultCode?(console.log("Control Transfer Failed: "+e),t.reject(e)):t.resolve(e)}),t.promise},e.bulkTransfer=function(e){var t=r.defer();return chrome.usb.bulkTransfer(a,e,function(e){e.resultCode?(console.log("Bulk Transfer Failed: "+e),t.reject(e)):t.resolve(e)}),t.promise},e.keyReset=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:3147,index:1,data:new Uint8Array(0).buffer,timeout:0};return e.controlTransfer(r)},e.keyWrite=function(r){var t={direction:l.bulkOut.direction,endpoint:l.bulkOut.address,data:new Uint8Array(r).buffer},n={direction:"out",recipient:"device",requestType:"vendor",request:1,value:4213,index:r.length,data:new Uint8Array(0).buffer,timeout:0};return e.bulkTransfer(t).then(function(){return e.controlTransfer(n)})},e.keyWriteBit=function(r){var t={direction:"out",recipient:"device",requestType:"vendor",request:1,value:545|r<<3,index:0,data:new Uint8Array(0).buffer,timeout:0};return e.controlTransfer(t)},e.keyRead=function(r){var t={direction:l.bulkIn.direction,endpoint:l.bulkIn.address,length:r};return e.bulkTransfer(t).then(function(e){return new Uint8Array(e.data)})},e.keyReadBit=function(){var r={direction:"out",recipient:"device",requestType:"vendor",request:1,value:41,index:0,data:new Uint8Array(0).buffer,timeout:0};return e.controlTransfer(r).then(function(r){return e.keyRead(1)}).then(function(e){return e[0]})};var h={lastDiscrepancy:0,lastDevice:!1,keys:[]},p=function(e){var t=r.defer();return k(e).then(function(e){if(h=e,e.keys&&e.keys[0]){var r=e.keys[0].reverse();r.toHexString=function(){return D(this)},t.resolve(r)}else t.reject()}),t.promise};e.keySearchFirst=function(){var e={lastDiscrepancy:0,lastDevice:!1,keys:[]};return p(e)},e.keySearchNext=function(e){return p(h)};var k=function(r){var t={idBitNumber:1,lastZero:0,romByteNumber:0,romByteMask:1,searchResult:!1,idBit:0,cmpIdBit:0,searchDirection:0,romId:new Uint8Array(8),lastDevice:!1,lastDiscrepancy:r.lastDiscrepancy};return e.keyReset().then(function(){return e.keyWrite(new Uint8Array([240]))}).then(function(){return e.keyRead(1)}).then(function(){return b(t)}).then(function(e){return e.searchResult&&r.keys.push(e.romId),r.lastDiscrepancy=e.searchResultObject,r.lastDevice=e.lastDevice,r})},b=function(r){return e.keyReadBit().then(function(e){r.idBit=e}).then(function(){return e.keyReadBit()}).then(function(t){return r.cmpIdBit=t,1!==r.idBit||1!==r.cmpIdBit?(r.idBit!=r.cmpIdBit?r.searchDirection=r.idBit:(r.idBitNumber<r.lastDiscrepancy?r.searchDirection=(r.romId[r.romByteNumber]&r.romByteMask)>0?1:0:r.searchDirection=r.idBitNumber==r.lastDiscrepancy?1:0,0===r.searchDirection&&(r.lastZero=r.idBitNumber)),1===r.searchDirection?r.romId[r.romByteNumber]|=r.romByteMask:r.romId[r.romByteNumber]&=~r.romByteMask,e.keyWriteBit(r.searchDirection).then(function(){return r.idBitNumber++,r.romByteMask<<=1,r.romByteMask>=256&&(r.romByteNumber++,r.romByteMask=1),r.romByteNumber<8?b(r):(r.idBitNumber>=65&&0===n(r.romId)&&(r.lastDiscrepancy=r.lastZero,0===r.lastDiscrepancy&&(r.lastDevice=!0),r.searchResult=!0),(r.searchResult===!1||0===r.romId[0])&&(r.lastDiscrepancy=0,r.lastDevice=!1,r.searchResult=!1),r)})):r})},D=function(e){const r=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var t="";return e.map(function(e){t+=r[e>>4&15]+r[15&e]}),t};return e};